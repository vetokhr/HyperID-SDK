# HyperID SDK Swift quick start guide

## Install

Open your app project and add HyperID SDK using Swift Package Manager:
1. Open your `context menu` on your app in the `Project Navigator`
2. Press `Add Package Dependencies...`
3. In seaarch field enter this `repository address`
4. Press `Add Package`

## Take credentials

Visit [HyperID DeveloperPortal](https://dev.hypersecureid.com)
1. At registration enter your project name
2. Open `Clients` tab and create your first client
    * choose your client name
    * choose environment
    > `public` or `testnet`
    * select client authentication type
    > `secret`, `secret sign`, `generated by service` or `your own` RS256 certificate with the private key
    > **Pay attention:** if you `generate` your certificate with our service, you should download certificate data to `continue` on this step.
    * setup redirect URI 
    > For secure browsing using Apple's `AuthenticationServices` framework, we strongly recomend you to use redirect URI with custom schemes like `hyperhttps://*`
3. Open created client and save `client secret`

## Initialization

Import HyperIDSDK to your sources

```Swift
import HyperIDSDK
```

Instansiate HyperID SDK with using your new client info

```Swift
//client info for default auth with pair client_id, client_secret
let clientInfo = ClientInfo(clientId:			"your_client_id",
			    redirectURL:		"hyperhttps://*",
			    authorizationMethod:	.clientSecret(secret: "your_secret"))
//client info for extended auth with JWT token signed with your secret using HS256
let clientInfoHS256 = ClientInfo(clientId:		"your_client_id_with_hs256_support",
				 redirectURL:		"hyperhttps://*",
				 authorizationMethod:	.clientHS256(secret: "your_secret"))
//client info for extended auth with JWT token signed with your secret using certificate RS256 private key
let keyData : Data = /*put your certificate private key data here*/
let clientInfoHS256 = ClientInfo(clientId:		"your_client_id_with_hs256_support",
				 redirectURL:		"hyperhttps://*",
				 authorizationMethod:	.clientRS256(privateKey: keyData))

let hyperIdSDK = try await HyperIDSDK(clientInfo: clientInfo,
				      )
```

And we're ready to work!

## Authorization

For next actions you should authorize your user. Basicaly magic happens on HyperID Service. Just select required method which will returns URL to authorize.
1. Our dear old `Web2`
```Swift
let url = try hyperIdSDK.startSignInWeb2()
//or little cheat variant to force user KYC check
let url = try hyperIdSDK.startSignInWeb2(kycVerificationLevel: .basic)
let url = try hyperIdSDK.startSignInWeb2(kycVerificationLevel: .full)
```
2. `Web3` with using `WalletConnect` protocol
```Swift
let url = try hyperIdSDK.startSignInWeb3()
//or little cheat variant to force user KYC check
let url = try hyperIdSDK.startSignInWeb3(kycVerificationLevel: .basic)
let url = try hyperIdSDK.startSignInWeb3(kycVerificationLevel: .full)
```
>**Note:** Basic Web3 network is `Ethereum`, **BUT** you can specify `Solana` network. See details in doc.
3. Login with your `Wallet`
```Swift
let url = try hyperIdSDK.startSignInUsingWallet()
//you can specify wallet onwership check. Btw we're support not only ethereum network.
let url = try hyperIdSDK.startSignInUsingWallet(walletGetMode:	.walletGetFull,
					       	walletFamily:	.solana)
```
4. You can upgrade `guest` account using this SDK:
```Swift
let url = try hyperIdSDK.startSignInGuestUpgrade()
```
5. Or select identity provider like `Google` or `AppleID`
```Swift
let url = try hyperIdSDK.startSignInIdentityProvider(identityProvider: .google)
//KYC cheat works here too.
let url = try hyperIdSDK.startSignInIdentityProvider(identityProvider:		.google
						     kycVerificationLevel:	.full)
```
The single step you need to do is to start authorization. We recomend you to use `AuthenticationServices` to protect user privacy [or you are free to implement your own web view]. Complete it in our SDK and continue the work.

```Swift
import AuthenticationServices
import HyperIDSDK

let url = try hyperIdSDK.startSignInWeb2()
let authSession = ASWebAuthenticationSession(url:		authURL,
					     callbackURLScheme:	"hyperhttps://*",
					     completionHandler:	{ redirectURL, error in
	if let redirectURL = redirectURL {
		Task {
			try await self.hyperIDSDK.completeSignIn(redirectURL: redirectURL)
		}
	}
})
//
//another auth session configurations
//
authSession?.start()
```
> **Note:** ASWebAuthenticationSession for start required setuped `presentationContextProvider` which gives `UIWindow` for auth modal view presentation. See details in our [Sample App](Link_placeholder)

You're authorized!

## Authorization state storage

Asking user authorization on every app start isn't completely good practice. We've carried this. Authorized HyperIDSDK contains `authRestoreInfo` parameter which you can setup during initialization:
```Swift
let hyperIdSDK = try await HyperIDSDK(clientInfo:       clientInfo,
				      authRestoreInfo:  authRestoreInfo,
				      providerInfo:     .sandbox
```
Just don't forget to save it. See details in our [Sample App](Link_placeholder)

## MFA

If you want to authorize some user actions use HyperID MFA API.

### Step 1:
 Check is MFA available for user (does they use HyperID Authenticator).
 ```Swift
 let isMFAAvailable = try await hyperIdSDK.checkMFAAvailability()
 ```

### Step 2:
 Ask them for authorization your action. Use question with simple possible response `Accept` or `Decline`. Add control code to validate exactly your question.

 ```Swift
 do {
	let controlCode		= Int.random(in: 0..<100)
	let mfaTransactionId	= try await hyperIDSDK.startMFATransaction(question:	question,
									   controlCode: controlCode!)
	return
} catch HyperIDAPIMFAError.controlCodeInvalidValue {
	// use 2 symbol control code, dont make user's life harder			
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
 ```

### Step 3:
Update transaction status till see different result
```Swift
do {
	mfaTransactionStatus = try await hyperIDSDK.getMFATransactionStatus(transactionId: mfaTransactionId)
	if mfaTransactionStatus == nil {
		//transaction not found
	}
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again		
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```
#### Available transaction states
```Swift
public enum MFATransactionStatus {
	case pending
	case completed(approved: MFACompleteResult)
	case expired
	case canceled
}

public enum MFACompleteResult {
	case approved
	case denied
}
```

### Cancelation

Sometimes you need to already sended to user transaction. You can do this using next code:
```Swift
do {
	try await hyperIDSDK.cancelMFATransaction(transactionId: mfaTransactionId!)
} catch HyperIDAPIMFAError.MFATransactionNotFound {
	// transaction not found. Have you really started it?
} catch HyperIDAPIMFAError.MFATransactionAlreadyCompleted {
	// transaction completed no way to cancel
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

## KYC

You can check user KYC information with next two methods

### User KYC status Top level info

Next method allows you to get info about user's top KYC level and ask it information and returns next structure 
```Swift
public struct UserKYCStatusTopLevelInfo {
	public var	verificationLevel		: KYCVerificationLevel
	public var	userStatus			: UserKYCStatus
	public var	createDt			: Date
	public var	reviewCreateDt			: Date
	public var	reviewCompleteDt		: Date
}
```
```Swift
do {
	let kycStatusTopLevelInfo = try await hyperIDSDK.getUserKYCStatusTopLevelInfo()
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

### User KYC status info

Next method gives to you detailed user KYC Status information in the next format
```Swift
public struct UserKYCStatusInfo {
	public var	verificationLevel		: KYCVerificationLevel
	public var	userStatus			: UserKYCStatus
	public var	kycId				: String?		= nil
	public var	firstName			: String?		= nil
	public var	lastName			: String?		= nil
	public var	birthday			: String?		= nil
	public var	countryA2			: String?		= nil
	public var	countryA3			: String?		= nil
	public var	providedCountryA2		: String?		= nil
	public var	providedCountryA3		: String?		= nil
	public var	addressCountryA2		: String?		= nil
	public var	addressCountryA3		: String?		= nil
	public var	phoneNumberCountryA2		: String?		= nil
	public var	phoneNumberCountryA3		: String?		= nil
	public var	phoneNumberCountryCode		: String?		= nil
	public var	ipCountriesA2			: [String]?		= nil
	public var	ipCountriesA3			: [String]?		= nil
	public var	moderationComment		: String?		= nil
	public var	rejectReasons			: [String]?		= nil
	public var	supportLink			: URL?			= nil
	public var	createDt			: Date
	public var	reviewCreateDt			: Date
	public var	reviewCompleteDt		: Date
	public var	expirationDt			: Date
}
```

```Swift
do {
	let ycStatusInfo = try await hyperIDSDK.getUserKYCStatusInfo(kycVerificationLevel: .basic/*.full*/)
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

## Storage

Store and share(if needed) user depend data to the HyperID to more than 4 types of storages: `.userId`, `.email`, `.wallet`, `.identityProvider`. 
> **Pay attention:** Every kind of storage connected some identifier:
> * `.userId` connected to user's HyperID account and cannot be losed or transfered
> * `.email` connected to user's account email and with email change data will removed/transfered to another account
> * `.wallet` connected to user's crypto wallet address. If they disconnect wallet data will be lost. Also several wallets can be connecte to one HyperID account. See below
> * `.identityProvider` connected to user external account which was used for authorization in HyperID with identity provider: Google, AppleID, Twitter, Telegram, Discord, etc. Eachone is separate namespace which can be losed on account unlink

Types of storage specified by next enum

```Swift
public enum HyperIDStorageType {
	case email
	case userID
	case wallet(address: String)
	case identityProvider(_: IdentityProvider)
}
```

Data stored to storage coud be specified as private or public. Public keys could be loaded and used by other clients. (See Shared Keys section below).

### Set data
```Swift
do {
	try await hyperIDSDK.setUserData((key: key, value: value),
					 dataScope:	.private,
					 storage:	.userId)
} catch HyperIDAPIStorageError.keyInvalid {
	// Key invalid. Is it empty?
} catch HyperIDAPIStorageError.keyAccessDenied {
	// Attempt to edit shared by other client public value
} catch HyperIDAPIStorageError.identityProviderNotFound {
	// Unsupported identity provider or no attached accounts with this provider
} catch HyperIDAPIStorageError.walletNotExists {
	// Wallet address isn't connected with this HyperID account or invalid
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

### Get data

```Swift
do {
	let value = try await hyperIDSDK.getUserData(key, storage: storage)
	if let value = value {
		//value not found
	}
} catch HyperIDAPIStorageError.identityProviderNotFound {
	// Unsupported identity provider or no attached accounts with this provider		
} catch HyperIDAPIStorageError.walletNotExists {
	// Wallet address isn't connected with this HyperID account or invalid
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

### Delete data

```Swift
do {
	try await hyperIDSDK.deleteUserData(key, storage: storage)
} catch HyperIDAPIStorageError.identityProviderNotFound {
	// Unsupported identity provider or no attached accounts with this provider		
} catch HyperIDAPIStorageError.walletNotExists {
	// Wallet address isn't connected with this HyperID account or invalid
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

### Load storage client keys

```Swift
do {
	let (keysPrivate: keysPrivate, keysPublic: keysPublic) = try await hyperIDSDK.getUserKeysList(storage: storage)
} catch HyperIDAPIStorageError.identityProviderNotFound {
	// Unsupported identity provider or no attached accounts with this provider		
} catch HyperIDAPIStorageError.walletNotExists {
	// Wallet address isn't connected with this HyperID account or invalid
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```

### Load storage shared keys

```Swift
do {
	clientSharedKeys = try await hyperIDSDK.getUserSharedKeysList(storage: storage)
} catch HyperIDAPIStorageError.identityProviderNotFound {
	// Unsupported identity provider or no attached accounts with this provider		
} catch HyperIDAPIStorageError.walletNotExists {
	// Wallet address isn't connected with this HyperID account or invalid
} catch HyperIDSDKError.authorizationExpired {
	// Oops! authorization expired. Please complete it again and try to send request again
} catch HyperIDAPIBaseError.serverMaintenance {
	// HyperID isn't available yet. Please wait. We're making awersome update
} catch HyperIDAPIBaseError.networkingError(description: let desc) {
	// Oops. Some device networking errors. See description.
}
```